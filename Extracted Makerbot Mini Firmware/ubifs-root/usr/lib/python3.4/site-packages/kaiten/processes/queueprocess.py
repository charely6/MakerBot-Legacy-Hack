import logging

import kaiten.error

from kaiten.processes.process import Process

class QueueProcess(Process):
    def __init__(self, machine_manager, pymach, queue):
        super(QueueProcess, self).__init__(machine_manager, pymach,
                                           machine_manager._config)
        self._queue = queue

    def _do_run(self):
        yield from self._pymach.toggle_expend_buffer(False)
        try:
            for _tuple in self._queue:
                # HACKY: way of geting args
                yield from self._call_pymach(_tuple[0], *[], **_tuple[1])
            yield from self._pymach.toggle_expend_buffer(True)
            while not self._pymach.move_buffer_empty():
                yield kaiten.error.ok
        except Exception as e:
            self._log.info("Error running")
            raise

    def _do_cleanup(self):
        yield from self._pymach.toggle_expend_buffer(True)

    def get_info_dict(self):
        info = {}
        info.update(super(QueueProcess, self).get_info_dict())
        return info
